/*
 * Copyright (C) 2009-2020 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["fin/cash/flow/analyzer/controller/BaseController","sap/ui/model/json/JSONModel","fin/cash/flow/analyzer/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/NavigationHandler","fin/cash/flow/analyzer/util/StringUtil","fin/cash/flow/analyzer/util/ErrorHandler","fin/cash/flow/analyzer/util/Conversions","fin/cash/flow/analyzer/util/Formatter"],function(B,J,f,F,a,S,N,b,E,C,c){"use strict";return B.extend("fin.cash.flow.analyzer.controller.DetailList",{Conversions:C,Formatter:c,onInit:function(){this.oFilterStr=null;this.oSelRow=null;this.utilConversion=C;this.oNavigationHandler=new N(this);this.oCurrSmartTable=this.getView().byId("idDetailListSmartTable");this.oCurrAnalyticalTable=this.getView().byId("idDetailListTable");this.oCurrSmartFilterBar=this.getView().byId("idDetailListSmartFilterBar");this.oResourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());if(sap.ui.Device.system.desktop){this.getView().addStyleClass("sapUiSizeCompact");this.oCurrSmartTable.addStyleClass("sapUiSizeCondensed");}else{this.getView().addStyleClass("sapUiSizeCozy");this.oCurrSmartTable.addStyleClass("sapUiSizeCozy");}var p=new sap.ui.model.json.JSONModel();this.getView().setModel(p,"page");this.getRouter().attachRoutePatternMatched(this.onRoutePatternMatched,this);},onRoutePatternMatched:function(e){var h=sap.ui.core.routing.History.getInstance();if(h.getDirection()==="Backwards"||h.getDirection()==="Forwards"||(h.getDirection()==="Unknown"&&h.aHistory.length!==1)||(h.aHistory.length===2&&h.aHistory[1].substring(0,1)==="L")||(h.aHistory.length===2&&h.aHistory[1].substring(0,1)==="B")){return;}var t=this.oResourceBundle.getText("DETAIL_PAGE_NAVIGATION_TITLE");this.getOwnerComponent().getService("ShellUIService").then(function(o){if(o){o.setTitle(t);}});var A=e.getParameter("arguments");var n=null;if(A){n=JSON.parse(String.fromBase64URI(A.Params));}n=$.extend({pSelRow:null,pAmount:null,pSetting:null},n);this.oSelRow=n.pSelRow;var s=this.oSelRow;this._getDirection(s);s.Amount=n.pAmount;s.Scaling=n.pSetting.scaling;s.isBankCurrency=n.pSetting.isBankCurrency;if(s.BankAccount!==undefined){if(s.BankAccountName!==undefined&&s.BankAccountName!==""){s.FullBankAccount=s.BankAccount+" ("+s.BankAccountName+")";}else{s.FullBankAccount=s.BankAccount;}}if(s.CompanyCode!==undefined){if(s.CompanyCodeName!==undefined&&s.CompanyCodeName!==""){s.FullCompanyCode=s.CompanyCode+" ("+s.CompanyCodeName+")";}else{s.FullCompanyCode=s.CompanyCode;}}if(s.BankGroup!==undefined){if(s.BankGroupName!==undefined&&s.BankGroupName!==""){s.FullBankGroup=s.BankGroup+" ("+s.BankGroupName+")";}else{s.FullBankGroup=s.BankGroup;}}if(s.DisplayPlanningLevel!==undefined){if(s.PlanningLevelDesc!==undefined&&s.PlanningLevelDesc!==""){s.FullPlanningLevel=s.DisplayPlanningLevel+" ("+s.PlanningLevelDesc+")";}else{s.FullPlanningLevel=s.DisplayPlanningLevel;}}if(s.CashPlanningGroup!==undefined){if(s.CashPlanningGroupDesc!==undefined&&s.CashPlanningGroupDesc!==""){s.FullPlanningGroup=s.CashPlanningGroup+" ("+s.CashPlanningGroupDesc+")";}else{s.FullPlanningGroup=s.CashPlanningGroup;}}if(s.LiquidityItem!==undefined){if(s.LiquidityItemName!==undefined&&s.LiquidityItemName!==""){s.FullLiquidityItem=s.LiquidityItem+" ("+s.LiquidityItemName+")";}else{s.FullLiquidityItem=s.LiquidityItem;}}this._setVisible(s.DirectionText,"idFlowDirection");this._setVisible(s.BankAccount,"idBankAccount");this._setVisible(s.CompanyCode,"idCompanyCode");this._setVisible(s.Bank,"idBank");this._setVisible(s.BankCountry,"idBankCountry");this._setVisible(s.BankGroup,"idBankGroup");this._setVisible(s.HouseBank,"idHouseBank");this._setVisible(s.HouseBankAccount,"idHouseBankAccount");this._setVisible(s.CertaintyLevel,"idCertaintyLevel");this._setVisible(s.DisplayPlanningLevel,"idPlanningLevel");this._setVisible(s.CashPlanningGroup,"idPlanningGroup");this._setVisible(s.LiquidityItem,"idLiquidityItem");this._setVisible(s.GLAccount,"idGLAccount");this._setVisible(s.ProfitCenter,"idProfitCenter");this._setVisible(s.BusinessArea,"idBusinessArea");this._setVisible(s.PaymentMethod,"idPaymentMethod");this._setVisible(s.Segment,"idSegment");this._setVisible(s.SummarizationTerm,"idSummarizationTerm");this._setVisible(s.TradingPartner,"idTradingPartner");if(this.oCurrSmartFilterBar.isInitialised()===true&&!this.oShareActionSheet===true){this._initSmartFilterBar();}},onInitSmartFilterBar:function(){if(this.oCurrSmartFilterBar.isInitialised()===true){this._initSmartFilterBar();}},_initSmartFilterBar:function(){var t=this;var s=t.getView().byId("idDetailListSmartFilterBar");var o=t.oSelRow;var p=t.oNavigationHandler.parseNavigation();var T=t.utilConversion.getHistoryDateTimeDefault();p.done(function(A,u,n){var d=null;if(n===sap.ui.generic.app.navigation.service.NavType.iAppState){d=new S(A.selectionVariant);}else{d=t.getOwnerComponent().getSelectionVariant();d.removeParameter("CyclePattern");d.removeParameter("TransferFrom");d.removeParameter("TransferTo");d.removeParameter("preferredMode");d.removeParameter("ReleaseFlag");d.renameParameter("HistoricalTimeStamp","SnapshotTimestamp");d.removeParameter("LiquidityHierarchyName");d.removeParameter("DisplayCurrency");d.renameSelectOption("AccId","BankAccountInternalID");d.renameSelectOption("BankAccount","BankAccountNumber");d.renameSelectOption("ReconcliationStatus","ReconciliationStatus");d.addSelectOption("ReconciliationStatus","I","EQ","0");var v=d.getSelectOption("ValueDate");d.removeSelectOption("ValueDate");d.addSelectOption("ValueDate","I","BT",v[0].Low.substring(0,v[0].Low.length-1),v[0].High.substring(0,v[0].High.length-1));if(o.BankAccountGroup!==undefined){var e=o.sortid+"%";d.addParameter("SortOrder",e);}if(o.Direction!==undefined){d.addParameter("Direction",o.Direction);}if(o.AccId!==undefined){d.removeSelectOption("BankAccountInternalID");d.addParameter("BankAccountInternalID",o.AccId);}if(o.Bank!==undefined){d.removeSelectOption("Bank");d.addParameter("Bank",o.Bank);}if(o.BankAccount!==undefined){d.removeSelectOption("BankAccountNumber");d.addParameter("BankAccountNumber",o.BankAccount);}if(o.BankAccountCurrency!==undefined){switch(o.isBankCurrency){case"":d.addParameter("TransactionCurrency",o.BankAccountCurrency);break;case"X":d.addParameter("AccountCurrency",o.BankAccountCurrency);break;case"L":d.addParameter("CompanyCodeCurrency",o.BankAccountCurrency);break;}d.removeParameter("Currency");d.removeParameter("BankAccountCurrency");d.removeParameter("LocalCurrency");d.removeSelectOption("Currency");d.removeSelectOption("BankAccountCurrency");d.removeSelectOption("LocalCurrency");}if(o.BankAccountCurrency===undefined&&o.DisplayCurrency!==undefined){switch(o.isBankCurrency){case"":d.renameParameter("Currency","TransactionCurrency");d.renameParameter("BankAccountCurrency","TransactionCurrency");d.renameParameter("LocalCurrency","TransactionCurrency");d.renameSelectOption("Currency","TransactionCurrency");d.renameSelectOption("BankAccountCurrency","TransactionCurrency");d.renameSelectOption("LocalCurrency","TransactionCurrency");break;case"X":d.renameParameter("Currency","AccountCurrency");d.renameParameter("BankAccountCurrency","AccountCurrency");d.renameParameter("LocalCurrency","AccountCurrency");d.renameSelectOption("Currency","AccountCurrency");d.renameSelectOption("BankAccountCurrency","AccountCurrency");d.renameSelectOption("LocalCurrency","AccountCurrency");break;case"L":d.renameParameter("Currency","CompanyCodeCurrency");d.renameParameter("BankAccountCurrency","CompanyCodeCurrency");d.renameParameter("LocalCurrency","CompanyCodeCurrency");d.renameSelectOption("Currency","CompanyCodeCurrency");d.renameSelectOption("BankAccountCurrency","CompanyCodeCurrency");d.renameSelectOption("LocalCurrency","CompanyCodeCurrency");break;}}if(o.BankCountry!==undefined){d.removeSelectOption("BankCountry");d.addParameter("BankCountry",o.BankCountry);}if(o.BankGroup!==undefined){d.removeSelectOption("BankGroup");d.addParameter("BankGroup",o.BankGroup);}if(o.BusinessArea!==undefined){d.removeSelectOption("BusinessArea");d.addParameter("BusinessArea",o.BusinessArea);}if(o.CashPlanningGroup!==undefined){d.removeSelectOption("CashPlanningGroup");d.addParameter("CashPlanningGroup",o.CashPlanningGroup);}if(o.CertaintyLevel!==undefined){d.removeSelectOption("CertaintyLevel");d.addParameter("CertaintyLevel",o.CertaintyLevel);}if(o.CompanyCode!==undefined){d.removeSelectOption("CompanyCode");d.addParameter("CompanyCode",o.CompanyCode);}if(o.DisplayPlanningLevel!==undefined){d.removeSelectOption("DisplayPlanningLevel");d.addParameter("DisplayPlanningLevel",o.DisplayPlanningLevel);}if(o.GLAccount!==undefined){d.removeSelectOption("GLAccount");d.addParameter("GLAccount",o.GLAccount);}if(o.HouseBank!==undefined){d.removeSelectOption("HouseBank");d.addParameter("HouseBank",o.HouseBank);}if(o.HouseBankAccount!==undefined){d.removeSelectOption("HouseBankAccount");d.addParameter("HouseBankAccount",o.HouseBankAccount);}if(o.PaymentMethod!==undefined){d.removeSelectOption("PaymentMethod");d.addParameter("PaymentMethod",o.PaymentMethod);}if(o.LiquidityItem!==undefined){d.removeSelectOption("LiquidityItem");d.addParameter("LiquidityItem",o.LiquidityItem);}if(o.ProfitCenter!==undefined){d.removeSelectOption("ProfitCenter");d.addParameter("ProfitCenter",o.ProfitCenter);}if(o.Segment!==undefined){d.removeSelectOption("Segment");d.addParameter("Segment",o.Segment);}if(o.SummarizationTerm!==undefined){d.removeSelectOption("SummarizationTerm");d.addParameter("SummarizationTerm",o.SummarizationTerm);}if(o.TradingPartner!==undefined){d.removeSelectOption("TradingPartner");d.addParameter("TradingPartner",o.TradingPartner);}}var v=d.getSelectOption("ValueDate");if(v[0].Low===v[0].High){o.SelDate=t.Formatter.formatDate(new Date(Date.parse(v[0].Low)));}else{o.SelDate=t.Formatter.formatDate(new Date(Date.parse(v[0].Low)))+" - "+t.Formatter.formatDate(new Date(Date.parse(v[0].High)));}var D=d.getParameter("DateIndicator");if(D==="2"){o.SelDateLabel=t.oResourceBundle.getText("POSTING_DATE");}else{o.SelDateLabel=t.oResourceBundle.getText("VALUE_DATE");}var g=d.getParameter("SnapshotTimestamp");if(g){T=new Date(Date.parse(g));}t.getView().byId("dtpSnapshotTimestamp").setDateValue(T);var h=d.getParameter("ExRateType");if(h){o.ExRateType=h;}var r=new J(o);t.getView().setModel(r,"selRow");if(!A.selectionVariant){t.storeNewAppState(d);}s.setDataSuiteFormat(d.toJSONString(),true);s.search();});},storeNewAppState:function(s){var A=this.oNavigationHandler.storeInnerAppState({selectionVariant:s.toJSONString()});var t=this;A.fail(function(e){t.arOwnerFilters(e);});},onHandleBeforeRebindTable:function(e){var o=e.getParameter("bindingParams");var t=this.getView().byId("dtpSnapshotTimestamp").getDateValue();o.filters.push(new sap.ui.model.Filter("SnapshotTimestamp","EQ",this.utilConversion.formatUTCDateString(t)));o.parameters.autoExpandMode="Sequential";o.parameters.provideGrandTotals=true;if(o.parameters.select){this.byId("idColumnCompanyCodeName").setInResult(false);this.byId("idColumnGLAccountName").setInResult(false);this.byId("idColumnLiquidityItemName").setInResult(false);this.byId("idColumnPlanningLevelName").setInResult(false);this.byId("idColumnCashPlanningGroupName").setInResult(false);this.byId("idColumnCustomerName").setInResult(false);this.byId("idColumnSupplierName").setInResult(false);this.byId("idColumnBankAccountDescription").setInResult(false);this.byId("idColumnPaymentMethodName").setInResult(false);this.byId("idColumnCertaintyLevelName").setInResult(false);var s=o.parameters.select.split(",");for(var i=0;i<s.length;i++){if(s[i]==="CompanyCode"){this.byId("idColumnCompanyCodeName").setInResult(true);}if(s[i]==="GLAccount"){this.byId("idColumnGLAccountName").setInResult(true);}if(s[i]==="LiquidityItem"){this.byId("idColumnLiquidityItemName").setInResult(true);}if(s[i]==="DisplayPlanningLevel"){this.byId("idColumnPlanningLevelName").setInResult(true);}if(s[i]==="CashPlanningGroup"){this.byId("idColumnCashPlanningGroupName").setInResult(true);}if(s[i]==="Customer"){this.byId("idColumnCustomerName").setInResult(true);}if(s[i]==="Supplier"){this.byId("idColumnSupplierName").setInResult(true);}if(s[i]==="BankAccountNumber"){this.byId("idColumnBankAccountDescription").setInResult(true);}if(s[i]==="PaymentMethod"){this.byId("idColumnPaymentMethodName").setInResult(true);}if(s[i]==="CertaintyLevel"){this.byId("idColumnCertaintyLevelName").setInResult(true);}}}},onPressNavigation:function(e){var s="M";var o=e.getSource().getBindingContext();if(!o){return;}var d=o.getModel().getProperty(o.getPath());if(d.AmountInTransactionCurrency&&d.AmountInTransactionCurrency===0){sap.m.MessageBox.warning(this.oResourceBundle.getText("MSG_UNRLZE_NOT_SUPPORT"));return;}if(this.oSelRow.ExRateType){s=this.oSelRow.ExRateType;}var g=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(g){var h=g.hrefForExternal({target:{semanticObject:"BankAccount",action:"analyzePaymentDetails"},params:{OriginApplication:d.OriginApplication,OriginDocument:d.OriginDocumentID,CashFlow:d.OriginFlowID,OriginSystem:d.OriginSystem,OriginTransactionQualifier:d.OriginTransQualifier,OriginTransaction:d.OriginTransactionID,ExchangeRateType:s,CashFlowSnapshotDateTime:this.getView().byId("dtpSnapshotTimestamp").getDateValue(),preferredMode:"display","sap-ushell-navmode":"explace"}})||"";sap.m.URLHelper.redirect(window.location.href.split('#')[0]+h,true);}},_setVisible:function(v,i){if(v!==undefined){this.byId(i).setVisible(true);}else{this.byId(i).setVisible(false);}},_getDirection:function(s){var d="";var D="";if(s.Direction!==undefined){if(s.Direction==="+"){d=this.oResourceBundle.getText("INFLOW");D="Success";}else if(s.Direction==="-"){d=this.oResourceBundle.getText("OUTFLOW");D="Error";}}if(s.ViewTypeExt!==undefined){if(s.ViewTypeExt==="1BEG_BAL"){d=this.oResourceBundle.getText("BEGINNINGBAL");D="None";}else if(s.ViewTypeExt==="3END_BAL"){d=this.oResourceBundle.getText("ENDINGBAL");D="None";}}if(d){s.DirectionText=d;s.DirectionState=D;}else{s.DirectionState="None";}},onShareButtonPressed:function(e){if(!this.oShareActionSheet){this.oShareActionSheet=sap.ui.xmlfragment(this.getView().getId(),"fin.cash.flow.analyzer.view.fragment.shareActionSheet",this);this.getView().addDependent(this.oShareActionSheet);}var s=new J();this.setModel(s,"share");this.oShareActionSheet.setModel(s,"share");s.setProperty("/bookmarkTitle",this.oResourceBundle.getText("appDescription"));s.setProperty("/bookmarkButtonText",this.oResourceBundle.getText("SEMANTIC_CONTROL_SAVE_AS_TILE"));var g=jQuery.sap.getObject("sap.ushell.Container.getUser");s.setProperty("/jamVisible",!!g&&g().isJamActive());this.oShareActionSheet.openBy(e.getSource());}});});
